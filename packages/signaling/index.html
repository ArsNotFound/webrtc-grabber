<script src="/socket.io/socket.io.js"></script>
<div id="peers"></div>
<video id="video"></video>
<script>
    let peerConnectionConfig;
    const socket = io("/admin");
    let pc = null;
    let curGrabberId = null;

    socket.on("init_peer", (pcConfig) => {
        peerConnectionConfig = pcConfig;
        console.log("set peerConnectionConfig");
    });
    socket.on("peers", (peers) => {
        const allPeersAnchor = document.getElementById('peers');
        allPeersAnchor.innerHTML = '';
        peers.forEach((peer) => {
            allPeersAnchor.innerHTML += `<div class="peer">
            <pre>
            ${JSON.stringify(peer)}
            </pre>
            <div>Last ping: ${peer.lastPing ? (new Date(peer.lastPing)).toLocaleString() : "never"}</div>
            <button onClick="connect('${peer.id}')">Connect</button>
        </div>`;
        });
    });

    const connect = (peerId) => {
        console.log(`send offer to ${peerId}`);
        curGrabberId = peerId;
        if(["connecting", "connected", undefined].indexOf(pc?.connectionState) !== -1) {
            pc?.close();
        }
        pc = new RTCPeerConnection(peerConnectionConfig);
        pc.addTransceiver("video");

        pc.addEventListener("track", (e) => {
            console.log("got track");
            const remoteVideo = document.getElementById("video");
            if (e.track.kind === "video" && e.streams.length > 0 && remoteVideo.srcObject !== e.streams[0]) {
                remoteVideo.srcObject = null;
                remoteVideo.srcObject = e.streams[0];
                remoteVideo.play();
                console.log('pc2 received remote stream');
            }
        })

        pc.createOffer().then(offer => {
            pc.setLocalDescription(offer)
            socket.emit("offer", peerId, offer);
        });

        pc.addEventListener("icecandidate", (event) => {
            console.log(`sending ice to ${curGrabberId}`);
            socket.emit("player_ice", curGrabberId, event.candidate);
        });
    }

    socket.on("offer_answer", async (peerId, answer) => {
        console.log(`got offer_answer from ${peerId}`);
        await pc.setRemoteDescription(answer);
        console.log("got offer_answer as remote description");
    })

    socket.on("grabber_ice", async (peerId, candidate) => {
        console.log(`got grabber_ice from ${peerId}`);
        await pc.addIceCandidate(candidate);
    });

    window.addEventListener("close", () => ps?.close());
</script>

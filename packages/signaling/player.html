<html>
<head>
    <title>WebRTC player</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            background-color: rgba(0, 0, 0, 0);
            margin: 0 auto;
            overflow: hidden;
        }

        #webrtcVideo {
            width: 100%;
        }

        #webrtcAudio {
            opacity: 0;
        }
    </style>
</head>
<body>
<video id="video" width="100%" autoplay muted></video>
</body>

</html>
<script>
    const extractArguments = () => {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("peerName")) {
            alert("Invalid parameters. No peerName argument");
        }
        return { peerName: params.get("peerName"), streamType: params.get("streamType"), credential: params.get("credential") };
    }
    const connectionArgs = extractArguments();

    let peerConnectionConfig;
    const socket = io("/admin", {
        auth: {
            token: connectionArgs.credential,
        },
    });
    socket.on("auth", (status) => {
        if (status === "forbidden") {
            localStorage.removeItem("adminCredentials");
            alert("Forbidden. Authorization failed");
        }
    });

    let pc = null;
    let curGrabberId = null;

    socket.on("init_peer", (pcConfig) => {
        peerConnectionConfig = pcConfig;
        console.log("set peerConnectionConfig");

        connect(connectionArgs.peerName, connectionArgs.streamType);
    });

    const connect = (peerName, streamType) => {
        console.log(`send offer to [${peerName}] ${streamType}`);
        if (["connecting", "connected", undefined].indexOf(pc?.connectionState) !== -1) {
            pc?.close();
        }
        pc = new RTCPeerConnection(peerConnectionConfig);
        pc.addTransceiver("video");
        pc.addTransceiver("audio");

        pc.addEventListener("track", (e) => {
            console.log("got track");
            const remoteVideo = document.getElementById("video");
            if (e.track.kind === "video" && e.streams.length > 0 && remoteVideo.srcObject !== e.streams[0]) {
                remoteVideo.srcObject = null;
                remoteVideo.srcObject = e.streams[0];
                remoteVideo.play();
                console.log('pc2 received remote stream', e.streams);
            }
        })

        pc.createOffer().then(offer => {
            pc.setLocalDescription(offer)
            socket.emit("offer_name", peerName, offer, streamType);
        });

        pc.addEventListener("icecandidate", (event) => {
            console.log(`sending ice to [${peerName}]`);
            socket.emit("player_ice_name", peerName, event.candidate);
        });
    }

    socket.on("offer_answer", async (peerId, answer) => {
        console.log(`got offer_answer from ${peerId}`);
        await pc.setRemoteDescription(answer);
        console.log("got offer_answer as remote description");
    })

    socket.on("grabber_ice", async (peerId, candidate) => {
        console.log(`got grabber_ice from ${peerId}`);
        await pc.addIceCandidate(candidate);
    });

    window.addEventListener("close", () => ps?.close());
</script>
